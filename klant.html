<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>FA Taxi Service - Ritprijs Berekening</title>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body {
      font-family: Arial;
      margin: 20px;
    }
    #resultaat {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>FA Taxi Ritprijs Berekening</h2>

  <button onclick="haalLocatieOp()">üìç Haal mijn locatie op</button>
  <input type="text" id="bestemming" placeholder="Afzetlocatie (adres)">
  <button onclick="berekenRit()">üöñ Bereken Ritprijs</button>

  <div id="resultaat">...</div>

  <script>
    let start = null; // klantlocatie

    function haalLocatieOp() {
      navigator.geolocation.getCurrentPosition(pos => {
        start = [pos.coords.longitude, pos.coords.latitude];
        document.getElementById('resultaat').innerText = "Locatie opgehaald!";
      });
    }

    async function geocodeAdres(adres) {
      const response = await axios.get("https://api.openrouteservice.org/geocode/search", {
        params: {
          api_key: "5b3ce3597851110001cf6248b59dc263cab24bdabda48748cd9122b3",
          text: adres
        }
      });
      const coords = response.data.features[0].geometry.coordinates;
      return coords;
    }

    function bepaalNachttoeslag() {
      const uur = new Date().getHours();
      return (uur >= 22 || uur < 6) ? 1.25 : 1;
    }

    function bepaalDrukteToeslag() {
      const uur = new Date().getHours();
      return (uur >= 7 && uur <= 9) || (uur >= 16 && uur <= 18) ? 1.2 : 1;
    }

    function berekenRitprijs(afstandKm, duurMin, routeVanafStandplaats) {
      let prijs = 0;
      const vasteTarieven = {
        3: 15, 4: 17.5, 5: 20, 6: 22.5,
        7: 25, 8: 27.5, 9: 30
      };

      if (afstandKm <= 9) {
        prijs = vasteTarieven[Math.ceil(afstandKm)] || 30;
      } else {
        prijs = 2.50 + 2.00 * afstandKm + 0.30 * duurMin;
      }

      if (routeVanafStandplaats > 5) {
        prijs += routeVanafStandplaats * 1.00;
      }

      const weer = document.getElementById("resultaat").innerText.includes("Regen") ? 1.2 : 1;
      prijs *= bepaalNachttoeslag() * bepaalDrukteToeslag() * weer;

      return prijs;
    }

    async function controleerWeer(lat, lon) {
      const api = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=precipitation`;
      const res = await fetch(api);
      const data = await res.json();
      return data.current.precipitation > 0;
    }

    async function berekenRit() {
      const bestemmingAdres = document.getElementById("bestemming").value;
      if (!start) return alert("Eerst locatie ophalen!");
      if (!bestemmingAdres) return alert("Voer een afzetlocatie in!");

      const eind = await geocodeAdres(bestemmingAdres);

      // Bereken afstand en tijd van rit
      const ritUrl = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=5b3ce3597851110001cf6248b59dc263cab24bdabda48748cd9122b3&start=${start[0]},${start[1]}&end=${eind[0]},${eind[1]}`;
      const ritRes = await fetch(ritUrl);
      const ritData = await ritRes.json();
      const afstandKm = ritData.features[0].properties.summary.distance / 1000;
      const duurMin = ritData.features[0].properties.summary.duration / 60;

      // Bereken afstand vanaf standplaats (voorbeeld: Amsterdam)
      const standplaats = [4.8952, 52.3702];
      const routeKlantUrl = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=5b3ce3597851110001cf6248b59dc263cab24bdabda48748cd9122b3&start=${standplaats[0]},${standplaats[1]}&end=${start[0]},${start[1]}`;
      const klantRes = await fetch(routeKlantUrl);
      const klantData = await klantRes.json();
      const routeVanafStandplaats = klantData.features[0].properties.summary.distance / 1000;

      // Weer check
      const regen = await controleerWeer(start[1], start[0]);

      if (regen) {
        document.getElementById("resultaat").innerText = "Let op: Regen, toeslag actief üåßÔ∏è";
      }

      const prijs = berekenRitprijs(afstandKm, duurMin, routeVanafStandplaats);

      document.getElementById("resultaat").innerText += `\nAfstand: ${afstandKm.toFixed(2)} km\nDuur: ${duurMin.toFixed(1)} min\nTotale ritprijs: ‚Ç¨${prijs.toFixed(2)}`;
    }
  </script>
</body>
</html>
